<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NAPAS VietQR ç”Ÿæˆå™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    label { display: block; margin-top: 1em; }
    input, select { width: 300px; padding: 5px; }
    #qrcode, #payloadOutput, #breakdown, #verifyResult, #txInfo, #structureError { margin-top: 2em; white-space: pre-wrap; font-family: monospace; background: #f8f8f8; padding: 1em; border-radius: 8px; }
    #uploadSection { margin-top: 2em; }
    #accountWarning, #prefixSuggestion { color: red; font-weight: bold; margin-top: 0.5em; }
  </style>
</head>
<body>
  <h2>NAPAS / VietQR Code ç”Ÿæˆå™¨</h2>
  <form id="qrForm">
    <label>éŠ€è¡Œä»£ç¢¼ï¼š
      <select id="bankCode" required>
        <option value="970415">VietinBank</option>
        <option value="970436">Vietcombank</option>
        <option value="970418">Techcombank</option>
        <option value="970407">BIDV</option>
        <option value="970422">MB Bank</option>
        <option value="970405">Agribank</option>
      </select>
    </label>
    <label>éŠ€è¡Œå¸³è™Ÿï¼ˆaccount numberï¼‰<input id="accountNumber" required></label>
    <div id="accountWarning"></div>
    <div id="prefixSuggestion"></div>
    <label>å¸³æˆ¶åç¨±ï¼ˆè«‹ä½¿ç”¨è‹±æ–‡å¤§å¯«ç„¡è²èª¿ï¼‰<input id="accountName" required></label>
    <label>é‡‘é¡ï¼ˆVNDï¼Œå¯é¸ï¼‰<input id="amount" type="number"></label>
    <label>é™„è¨€ï¼ˆå¯é¸ï¼‰<input id="message"></label>
    <button type="submit">ç”Ÿæˆ QR Code</button>
  </form>

  <div id="qrcode"></div>
  <div id="payloadOutput"></div>
  <div id="verifyResult"></div>
  <div id="structureError"></div>
  <div id="txInfo"></div>
  <div id="breakdown"></div>

  <div id="uploadSection">
    <h3>ğŸ–¼ï¸ ä¸Šå‚³ QR åœ–ç‰‡è§£æï¼š</h3>
    <input type="file" id="qrImageInput" accept="image/*">
    <canvas id="qrCanvas" style="display:none;"></canvas>
  </div>

  <script>
    function padLength(n) {
      return n.toString().padStart(2, '0');
    }

    function crc16(payload) {
      let crc = 0xFFFF;
      for (let i = 0; i < payload.length; i++) {
        crc ^= payload.charCodeAt(i) << 8;
        for (let j = 0; j < 8; j++) {
          if ((crc & 0x8000) !== 0) crc = (crc << 1) ^ 0x1021;
          else crc <<= 1;
        }
        crc &= 0xFFFF;
      }
      return crc.toString(16).toUpperCase().padStart(4, '0');
    }

    const BIN_PREFIX_MAP = {
      '970415': '0112', // VietinBank
      '970418': '003',  // BIDV (example)
      '970407': '06',   // Techcombank (example)
      // å¯æ“´å……æ›´å¤šéŠ€è¡Œ
    };

    document.getElementById("accountNumber").addEventListener("input", () => {
      const acct = document.getElementById("accountNumber").value.trim();
      const warning = document.getElementById("accountWarning");
      const prefix = document.getElementById("prefixSuggestion");

      const bin = document.getElementById("bankCode").value;
      const suggest = BIN_PREFIX_MAP[bin] || "";

      if (acct.length < 9 || acct.length > 15) {
        warning.innerText = "âš ï¸ å»ºè­°éŠ€è¡Œå¸³è™Ÿé•·åº¦ç‚º 9ï½15 ç¢¼ï¼Œå¦å‰‡å¯èƒ½å°è‡´ VietQR æƒç¢¼å¤±æ•—ã€‚";
      } else {
        warning.innerText = "";
      }

      if (acct.length <= 10 && suggest && !acct.startsWith(suggest)) {
        prefix.innerText = `ğŸ’¡ æç¤ºï¼š${getBankName(bin)} é€šå¸¸å¸³è™Ÿæœƒä»¥ã€Œ${suggest}ã€é–‹é ­ï¼Œå¯èƒ½éœ€è¦è£œä¸Šã€‚`;
      } else {
        prefix.innerText = "";
      }
    });

    function getBankName(bin) {
      switch (bin) {
        case '970415': return 'VietinBank';
        case '970418': return 'BIDV';
        case '970407': return 'Techcombank';
        case '970436': return 'Vietcombank';
        case '970422': return 'MB Bank';
        case '970405': return 'Agribank';
        default: return 'æ­¤éŠ€è¡Œ';
      }
    }
  </script>
</body>
</html>
