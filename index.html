<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NAPAS VietQR 生成器</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    label { display: block; margin-top: 1em; }
    input, select { width: 300px; padding: 5px; }
    #qrcode { margin-top: 2em; }
  </style>
</head>
<body>
  <h2>NAPAS / VietQR Code 生成器</h2>
  <form id="qrForm">
    <label>銀行代碼：
      <select id="bankCode" required>
        <option value="970415">VietinBank</option>
        <option value="970436">Vietcombank</option>
        <option value="970418">Techcombank</option>
        <option value="970407">BIDV</option>
        <option value="970422">MB Bank</option>
        <option value="970405">Agribank</option>
      </select>
    </label>
    <label>銀行帳號（account number）<input id="accountNumber" required></label>
    <label>帳戶名稱（請使用英文大寫無聲調）<input id="accountName" required></label>
    <label>金額（VND，可選）<input id="amount" type="number"></label>
    <label>附言（可選）<input id="message"></label>
    <button type="submit">生成 QR Code</button>
  </form>

  <div id="qrcode"></div>

  <script>
    function padLength(n) {
      return n.toString().padStart(2, '0');
    }

    function crc16(payload) {
      let crc = 0xFFFF;
      for (let i = 0; i < payload.length; i++) {
        crc ^= payload.charCodeAt(i) << 8;
        for (let j = 0; j < 8; j++) {
          if ((crc & 0x8000) !== 0) crc = (crc << 1) ^ 0x1021;
          else crc <<= 1;
        }
        crc &= 0xFFFF;
      }
      return crc.toString(16).toUpperCase().padStart(4, '0');
    }

    document.getElementById("qrForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const bankCode = document.getElementById("bankCode").value.trim();
      const account = document.getElementById("accountNumber").value.trim();
      const name = document.getElementById("accountName").value.trim().toUpperCase();
      const amount = document.getElementById("amount").value.trim();
      const message = document.getElementById("message").value.trim();

      const payload = [];

      payload.push("000201");
      payload.push("010212"); // 靜態 QR

      // Merchant Account Info (Tag 38)
      const fullAcct = `0006${bankCode}${account}`;
      const tag00 = "0010A000000727";
      const tag01 = `01${padLength(fullAcct.length)}${fullAcct}`;
      const value38 = `${tag00}${tag01}`;
      payload.push(`38${padLength(value38.length)}${value38}`);

      payload.push("0208QRIBFTTA");
      payload.push("5303704");

      if (amount) payload.push(`54${padLength(amount.length)}${amount}`);
      payload.push("5802VN");

      if (message) {
        const messageTag = `05${padLength(message.length)}${message}`;
        payload.push(`62${padLength(messageTag.length)}${messageTag}`);
      }

      let base = payload.join("");
      base += "6304";
      const checksum = crc16(base);
      base += checksum;

      document.getElementById("qrcode").innerHTML = "";
      QRCode.toCanvas(document.createElement("canvas"), base, { width: 256 }, function (err, canvas) {
        if (!err) document.getElementById("qrcode").appendChild(canvas);
      });
    });
  </script>
</body>
</html>
