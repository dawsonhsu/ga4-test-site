<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NAPAS VietQR ç”Ÿæˆå™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    label { display: block; margin-top: 1em; }
    input, select { width: 300px; padding: 5px; }
    #qrcode, #payloadOutput, #breakdown, #verifyResult, #txInfo, #structureError { margin-top: 2em; white-space: pre-wrap; font-family: monospace; background: #f8f8f8; padding: 1em; border-radius: 8px; }
    #uploadSection { margin-top: 2em; }
    #accountWarning { color: red; font-weight: bold; margin-top: 0.5em; }
  </style>
</head>
<body>
  <h2>NAPAS / VietQR Code ç”Ÿæˆå™¨</h2>
  <form id="qrForm">
    <label>éŠ€è¡Œä»£ç¢¼ï¼š
      <select id="bankCode" required>
        <option value="970415">VietinBank</option>
        <option value="970436">Vietcombank</option>
        <option value="970418">Techcombank</option>
        <option value="970407">BIDV</option>
        <option value="970422">MB Bank</option>
        <option value="970405">Agribank</option>
      </select>
    </label>
    <label>éŠ€è¡Œå¸³è™Ÿï¼ˆaccount numberï¼‰<input id="accountNumber" required></label>
    <div id="accountWarning"></div>
    <label>å¸³æˆ¶åç¨±ï¼ˆè«‹ä½¿ç”¨è‹±æ–‡å¤§å¯«ç„¡è²èª¿ï¼‰<input id="accountName" required></label>
    <label>é‡‘é¡ï¼ˆVNDï¼Œå¯é¸ï¼‰<input id="amount" type="number"></label>
    <label>é™„è¨€ï¼ˆå¯é¸ï¼‰<input id="message"></label>
    <button type="submit">ç”Ÿæˆ QR Code</button>
  </form>

  <div id="qrcode"></div>
  <div id="payloadOutput"></div>
  <div id="verifyResult"></div>
  <div id="structureError"></div>
  <div id="txInfo"></div>
  <div id="breakdown"></div>

  <div id="uploadSection">
    <h3>ğŸ–¼ï¸ ä¸Šå‚³ QR åœ–ç‰‡è§£æï¼š</h3>
    <input type="file" id="qrImageInput" accept="image/*">
    <canvas id="qrCanvas" style="display:none;"></canvas>
  </div>

  <script>
    function padLength(n) {
      return n.toString().padStart(2, '0');
    }

    function crc16(payload) {
      let crc = 0xFFFF;
      for (let i = 0; i < payload.length; i++) {
        crc ^= payload.charCodeAt(i) << 8;
        for (let j = 0; j < 8; j++) {
          if ((crc & 0x8000) !== 0) crc = (crc << 1) ^ 0x1021;
          else crc <<= 1;
        }
        crc &= 0xFFFF;
      }
      return crc.toString(16).toUpperCase().padStart(4, '0');
    }

    function breakdownPayload(payload) {
      let pos = 0;
      let breakdown = "\nğŸ” Payload Breakdown:";
      while (pos < payload.length) {
        const tag = payload.substr(pos, 2);
        const len = parseInt(payload.substr(pos + 2, 2), 10);
        const value = payload.substr(pos + 4, len);
        breakdown += `\nTag: ${tag}, Length: ${len}, Value: ${value}`;
        pos += 4 + len;
        if (tag === "63") break;
      }
      return breakdown;
    }

    function verifyCRC(payload) {
      const base = payload.slice(0, -4);
      const expected = payload.slice(-4);
      const calc = crc16(base);
      return `âœ… CRC æª¢æŸ¥ï¼š${calc === expected ? 'é€šé' : 'âŒ éŒ¯èª¤'}\nå¯¦éš›ï¼š${expected}\nè¨ˆç®—ï¼š${calc}`;
    }

    function extractTxInfo(payload) {
      let bankCode = "";
      let account = "";
      let amount = "";
      let message = "";
      let pos = 0;
      let structureError = "";
      while (pos < payload.length) {
        const tag = payload.substr(pos, 2);
        const len = parseInt(payload.substr(pos + 2, 2), 10);
        const value = payload.substr(pos + 4, len);
        if (tag === "38") {
          const tag00 = value.substr(0, 16);
          const tag01Len = parseInt(value.substr(16 + 2, 2));
          const tag01Val = value.substr(16 + 4, tag01Len);
          if (!/^0006[0-9]{6}/.test(tag01Val)) {
            structureError = "âš ï¸ éŠ€è¡Œå¸³è™Ÿæ®µæ ¼å¼ä¸æ­£ç¢ºï¼ˆæ‡‰ç‚º 0006+BIN+å¸³è™Ÿï¼‰";
          }
          const acctIndex = tag01Val.indexOf("0006");
          if (acctIndex >= 0) {
            bankCode = tag01Val.substr(acctIndex + 4, 6);
            account = tag01Val.substr(acctIndex + 10);
            const actualLen = tag01Val.length;
            if (actualLen !== tag01Len) {
              structureError = `âš ï¸ å¸³è™Ÿæ®µé•·åº¦éŒ¯èª¤ï¼šè²ç¨± ${tag01Len}ï¼Œå¯¦éš› ${actualLen}`;
            }
          }
        }
        if (tag === "54") amount = value;
        if (tag === "62") {
          let subPos = 0;
          while (subPos < value.length) {
            const subTag = value.substr(subPos, 2);
            const subLen = parseInt(value.substr(subPos + 2, 2));
            const subVal = value.substr(subPos + 4, subLen);
            if (subTag === "05") message = subVal;
            subPos += 4 + subLen;
          }
        }
        pos += 4 + len;
        if (tag === "63") break;
      }
      document.getElementById("structureError").innerText = structureError;
      return `ğŸ“‹ è§£æè½‰å¸³è³‡è¨Šï¼š\néŠ€è¡Œä»£ç¢¼: ${bankCode}\néŠ€è¡Œå¸³è™Ÿ: ${account}\né‡‘é¡(VND): ${amount || 'ï¼ˆç„¡ï¼‰'}\né™„è¨€: ${message || 'ï¼ˆç„¡ï¼‰'}`;
    }

    document.getElementById("accountNumber").addEventListener("input", () => {
      const acct = document.getElementById("accountNumber").value.trim();
      const warning = document.getElementById("accountWarning");
      if (acct.length < 9 || acct.length > 15) {
        warning.innerText = "âš ï¸ å»ºè­°éŠ€è¡Œå¸³è™Ÿé•·åº¦ç‚º 9ï½15 ç¢¼ï¼Œå¦å‰‡å¯èƒ½å°è‡´ VietQR æƒç¢¼å¤±æ•—ã€‚";
      } else {
        warning.innerText = "";
      }
    });

    document.getElementById("qrForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const bankCode = document.getElementById("bankCode").value.trim();
      const account = document.getElementById("accountNumber").value.trim();
      const name = document.getElementById("accountName").value.trim().toUpperCase();
      const amount = document.getElementById("amount").value.trim();
      const message = document.getElementById("message").value.trim();

      const payload = [];
      payload.push("000201");
      payload.push("010212");

      const fullAcct = `0006${bankCode}${account}`;
      const tag00 = "0010A000000727";
      const tag01 = `01${padLength(fullAcct.length)}${fullAcct}`;
      const value38 = `${tag00}${tag01}`;
      payload.push(`38${padLength(value38.length)}${value38}`);

      payload.push("0208QRIBFTTA");
      payload.push("5303704");
      if (amount) payload.push(`54${padLength(amount.length)}${amount}`);
      payload.push("5802VN");

      if (message) {
        const messageTag = `05${padLength(message.length)}${message}`;
        payload.push(`62${padLength(messageTag.length)}${messageTag}`);
      }

      let base = payload.join("");
      base += "6304";
      const checksum = crc16(base);
      base += checksum;

      document.getElementById("qrcode").innerHTML = "";
      QRCode.toCanvas(document.createElement("canvas"), base, { width: 256 }, function (err, canvas) {
        if (!err) document.getElementById("qrcode").appendChild(canvas);
      });

      document.getElementById("payloadOutput").innerText = `ğŸ§¾ Payload:\n${base}`;
      document.getElementById("verifyResult").innerText = verifyCRC(base);
      document.getElementById("txInfo").innerText = extractTxInfo(base);
      document.getElementById("breakdown").innerText = breakdownPayload(base);
    });
  </script>
</body>
</html>
